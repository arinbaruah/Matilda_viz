---
title: "Visualisation"
author: "Arindam Baruah"
format: html
---

```{r}
library(tidyverse)
library(ggthemes)
library(ggplot2)
library(janitor)
library(ggcirclepack)
```

```{r}
df_survey <- read_csv("data/survey.csv")
df_substance_deaths <- read_csv("data/death-rate-from-mental-health-and-substance-use-disorders-who.csv")
df_substance_deaths_age <- read_csv("data/deaths-substance-disorders-age-who.csv")
df_us_mental_deaths <- read_csv("data/US_mental_order_deaths.csv")
df_drug_dependency <- read_csv("data/mental-health-as-risk-for-drug-dependency.csv")
df_drug_gender <- read_csv("data/deaths-drug-use-disorders-by-sex.csv")
df_drug_deaths <- tibble(drug = c("Tobacco","Alcohol use (Indirect)","Illicit drugs","Alcogol use (Direct)"),
                         deaths = c(7.25*10^6,1.81*10^6,600638,158469)) # Deaths in 2021 by IHME, Global burden of disease
df_pop <- read_csv("data/population.csv",skip = 3)
```

```{r}
library(tidyverse)
library(stringr)
library(glue)
library(ggrepel)
library(ggplot2)
library(ggtext)
library(sysfonts)
library(showtext)
library(geomtextpath)
library(stringr)
library(ggplot2)
library(ggnewscale)
library(paletteer)
library(colorspace)
library(extrafont)
# caption handles
swd <- str_glue("#SWDchallenge: June 2024 &bull; Source: Synthetic data from ChatGPT<br>")  
li <- str_glue("<span style='font-family:fa6-brands'>&#xf08c;</span>")  
gh <- str_glue("<span style='font-family:fa6-brands'>&#xf09b;</span>")
mn <- str_glue("<span style='font-family:fa6-brands'>&#xf4f6;</span>")


# plot colors
bkg_col      <- colorspace::lighten("#fbfbf8", 0.05)    
title_col    <- "#3d3d3d"           
subtitle_col <- "#3d3d3d"     
caption_col  <- "#72647D"   
text_col     <- colorspace::darken("gray40" , 0.2)  

# fonts

font_add('fa6-brands','fontawesome/otfs/Font Awesome 6 Brands-Regular-400.otf') 
font_add_google("DM Serif Display", regular.wt = 400, family = "title")                 
font_add_google("Urbanist", regular.wt = 400, family = "subtitle")  
font_add_google("Quattrocento Sans", regular.wt = 400, family = "text")        
font_add_google("Merriweather", regular.wt = 400,family = "caption")

showtext_auto(enable = TRUE)  


X_icon <- glue("<span style='font-family:fa6-brands'>&#xe61b;</span>")

caption_text <- str_glue("{li} Arindam Baruah | {X_icon} @wizsights | {gh} arinbaruah | Source: TidyTuesday |#rstudio #ggplot2")

theme_set(theme_minimal(base_size = 15, base_family = "text"))                

# Theme updates

theme_update(
  plot.title.position   = "plot",
  plot.caption.position = "plot",
  legend.position       = 'plot',
  plot.margin           = margin(t = 10, r = 15, b = 0, l = 15),
  plot.background       = element_rect(fill = bkg_col, color = bkg_col),
  panel.background      = element_rect(fill = bkg_col, color = bkg_col),
  axis.title.x          = element_text(margin = margin(10, 0, 0, 0), size = rel(1), color = text_col, family = 'text', face = 'bold'),
  axis.title.y          = element_text(margin = margin(0, 10, 0, 0), size = rel(1), color = text_col, family = 'text', face = 'bold'),
  axis.text             = element_text(size = 10, color = text_col, family = 'text',face = "bold"),
  panel.grid.minor.y    = element_blank(),
  panel.grid.major.y    = element_line(linetype = "dotted", linewidth = 0.1, color = 'gray40'),
  panel.grid.minor.x    = element_blank(),
  panel.grid.major.x    = element_blank(),
  axis.line.x           = element_line(color = "#d7d7d8", linewidth = .2),
)
```


```{r}
df_drug_gender <- df_drug_gender %>% filter(Year == 2021)
df_pop <- df_pop %>% select(`Country Name`,`2021`) 
df_drug_gender <- inner_join(df_drug_gender,df_pop,by = c("Entity"="Country Name"))


```

```{r}
df_drug_gender %>% mutate(prop_male = 100*`Total deaths from drug use disorders among females` / `2021`) %>% filter(`Total deaths from drug use disorders among males` > 1000)
```
# Share of deaths across genders

```{r}
#| warning: false
continents <- c("North America","South America","Asia","Oceania","Africa","World")

imp_countries <- c("India","China","United States","Australia","Canada","Germany","United Kingdom")

options(scipen = 1000)

df_drug_gender <- df_drug_gender %>% filter()
gr1 <- ggplot(data = df_drug_gender %>% filter(!Entity %in% continents),
              aes(y = `Total deaths from drug use disorders among males`, 
x = `Total deaths from drug use disorders among females`)) + geom_point(color = "lightgray") +
  geom_point(data = df_drug_gender %>% filter(!Entity %in% continents & Entity %in% imp_countries),
             color = "steelblue",size = 3) +
  geom_abline(intercept = 0,slope = 1,linetype = "dashed",alpha = 0.3) + 
  geom_text_repel(data = df_drug_gender %>% filter(Entity %in% imp_countries),
                  aes(label = Entity,
                      hjust = -0.8,
                      vjust = 1.8),
                  size = 2.5,fontface = "bold") +
  scale_x_continuous(transform = "log10", labels = scales::comma) +
  scale_y_continuous(transform = "log10", labels = scales::comma) +
  labs(x =     "Female deaths (log)",
       y =     "Male deaths (log)",
       title = "Drug Use Disorders and Mortality: Understanding the Gender Gap",
       subtitle = "The data across various countries has revealed a concerning trend: the number of deaths resulting from drug use disorders <br> is significantly high in the <span style='color: darkred;'> United States </span>, with approximately <strong> 100,000 deaths recorded in 2021 alone </strong>. Furthermore, the data <br> suggests that in most countries, 
       males are disproportionately affected by drug use disorders, with <strong> death rates among males <br> consistently exceeding those among females </strong>. This highlights that males are at a far greater risk of succumbing to the <br> harmful effects of illicit drugs.",
       caption = "Source: IHME, Global Burden of Disease, 2021") +
  theme(legend.position = "top",
    legend.title.position = "top",
    legend.title = element_text(
      color = text_col,
      hjust = 0.5,
      family = "text",
      face = "bold",
      size = rel(1),
    ),
    legend.text = element_text(
      color = text_col,
      family = "text",
      size = rel(1),
      face = "bold"
    ),
    plot.title            = element_text(
      size                = rel(1),
      family              = "title",
      face                = "bold",
      color               = title_col,
      lineheight          = 0.3,
      margin              = margin(t = 5, b = 5),
      hjust               = 0.5
    ),        
    plot.subtitle         = element_markdown(
      size                = rel(0.6), 
      family              = 'subtitle',
      color               = subtitle_col,
      hjust               = 0,
      lineheight          = 0.2, 
      margin              = margin(t = 5, b = 1)
    ),
      plot.caption          = element_markdown(
      size                = rel(0.5), 
      family              = 'caption',
      color               = caption_col,
      lineheight          = 0.3,
      hjust               = 1,
      halign              = 0,
      margin              = margin(t = 10, b = 10)
    ),
    axis.title = element_markdown(
      size = rel(0.6)
    ),
    axis.text  = element_markdown(
      size = rel(0.6)
    )
  ) 


gr1
ggsave("images/Gender_death_rate.jpeg",gr1,dpi = 300,height = 6, width = 10)
```
```{r}
df_drug_gender %>% filter(Entity != continents) %>% arrange(-`Total deaths from drug use disorders among males`)
```


```{r}

my_col = c("United States" = "#A93226","Canada" = "#E67E22","North America" = "#AAB7B8", 
           "South America" = "#AAB7B8", "Asia" = "#AAB7B8","Oceania" = "#AAB7B8","Africa" = "#AAB7B8")
tags<- c("North America","South America","Asia","Oceania","Africa","United States","Canada")

gr2 <- ggplot(data = df_substance_deaths %>% filter(Entity %in% tags) , aes(x = Year,
                                       y = `Death rate from mental and substance use disorders among both sexes`
                                       )) + 
  geom_line(aes(group = Entity,colour = Entity),linewidth = 0.25) +
  geom_point(
        aes(color = Entity), fill = "grey96",
        shape = 21, size = 2, stroke = .25
    ) +
  geom_rect(
    xmin = 2020, xmax = 2022, 
    ymin = 0, ymax = 40,
    fill = "#F9E79F",
    alpha = 0.1
  )  +
  scale_color_manual(values = my_col |> lighten(.5)) +
    new_scale_color() +
    geom_smooth(
        aes(group = Entity, color = Entity),
        linewidth = 3, se = FALSE, lineend = "round"
    ) +

    scale_color_manual(values = my_col |> alpha(0.3)) +
    
    new_scale_color() +
    geom_textsmooth(
        aes(color = Entity, label = Entity),
        linewidth = .5, se = FALSE, lineend = "round",
        fontface = "bold"
    ) +     theme_minimal()  +
  annotate(
  "text",
  x = 2021,
  y = 10,
  colour = "#BA4A00",
  label = 'COVID-19', size = unit(3, "pt")
) + labs(x = "Year",
         y = "Deaths due to mental health and drug use disorder",
         title = "Global Trends in Deaths from Mental Health and Substance Use Disorders (2000-2022)",
         subtitle = "The number of deaths due to mental health and substance use disorders per 100,000 individuals over the years <br> reveals a troubling trend for two specific countries:<span style='color: darkred;'> the United States and Canada </span>. While the death rates have <br> remained relatively stable across other continents, North America presents a stark contrast. Both countries have <br> experienced a significant increase in deaths, particularly in recent years. <strong> This rise has been notably steep <br> following the COVID-19 pandemic </strong>,which may have exacerbated mental health issues due to extended periods <br> of isolation and other pandemic-related stressors. ",
         caption = "Source: World Health Organisation") +

    scale_color_manual(values = my_col |> darken(.25)) +
  theme(legend.position = "none",
    legend.title = element_text(
      color = text_col,
      hjust = 0.5,
      family = "text",
      face = "bold",
      size = rel(1),
    ),
    legend.text = element_text(
      color = text_col,
      family = "text",
      size = rel(1),
      face = "bold"
    ),
    plot.title            = element_text(
      size                = rel(1.1),
      family              = "title",
      face                = "bold",
      color               = title_col,
      lineheight          = 0.3,
      margin              = margin(t = 5, b = 5),
      hjust               = 0.5
    ),        
    plot.subtitle         = element_markdown(
      size                = rel(0.9), 
      family              = 'subtitle',
      color               = subtitle_col,
      hjust               = 0,
      lineheight          = 0.2, 
      margin              = margin(t = 5, b = 1)
    ),
      plot.caption          = element_markdown(
      size                = rel(0.8), 
      family              = 'caption',
      color               = caption_col,
      lineheight          = 0.3,
      hjust               = 1,
      halign              = 0,
      margin              = margin(t = 10, b = 10)
    ),
    axis.title = element_markdown(
      size = rel(0.7)
    ),
    axis.text  = element_markdown(
      size = rel(0.7),
      face = "bold"
    )
  ) + xlim(c(2000,2022)) 

gr2
ggsave("images/Global_death_rate.jpeg",gr2,dpi = 300,height = 6, width = 10)
```

```{r}
df_substance_deaths_age <- df_substance_deaths_age %>% clean_names()
df_substance_deaths_age_long <- df_substance_deaths_age %>% pivot_longer(cols = c(4:8),
                                                                         values_to = "deaths",
                                                                         names_to = "age_group")

dim_order <- c("0-4","5-14", "15-49", "50-69",">=70","all")


df_substance_deaths_age_long <- df_substance_deaths_age_long %>%  group_by(year) %>% mutate(age_group_clean = case_match(age_group,           "deaths_from_substance_use_disorders_among_both_sexes_aged_0_4_year_olds" ~ "0-4", 
                                                                                                                         "deaths_from_substance_use_disorders_among_both_sexes_aged_5_14_year_olds" ~ "5-14", 
                                                                                                                         "deaths_from_substance_use_disorders_among_both_sexes_aged_15_49_year_olds" ~ "15-49", 
                                                                                                                         "deaths_from_substance_use_disorders_among_both_sexes_aged_50_69_year_olds" ~ "50-69",
                                                                                                                         "deaths_from_substance_use_disorders_among_both_sexes_aged_70_year_olds" ~ ">=70",
                                                                                  .default = "all")) %>%
   mutate(age_group_clean = factor(age_group_clean, levels = dim_order))

```


```{r}

age_exclude <- c("all","0-4","5-14")
df_substance_deaths_age_long <- df_substance_deaths_age_long %>% filter(!age_group_clean %in% age_exclude)
df_substance_deaths_age_long_grouped <- df_substance_deaths_age_long %>% group_by(age_group_clean,year) %>% summarise(Total_deaths = sum(deaths))

df_substance_deaths_age_long_grouped$age_group_clean <- paste0(
    df_substance_deaths_age_long_grouped$age_group_clean," yrs"
)

df_substance_deaths_age_long_grouped <- df_substance_deaths_age_long_grouped %>% filter(year >= 2016)
df_substance_deaths_age_long_grouped <- df_substance_deaths_age_long_grouped %>% 
                                          mutate(Total_deaths = Total_deaths/10^6) %>% 
                                          mutate(Total_deaths = round(Total_deaths,1)) 

df_substance_deaths_age_long_grouped$Total_deaths_label <- paste0(
    df_substance_deaths_age_long_grouped$Total_deaths," mil"
)
```


```{r}
#| warning: false
title_text <- "Persistent Trends in Deaths from Mental Health and Substance Use Disorders <br> Among Middle-Aged Groups"

subtitle_text <- "A closer examination of deaths due to mental health and substance use disorders reveals <br> that middle-aged individuals, particularly those between 15-49 years, have <br> consistently  experienced the highest mortality rates. In recent years, the death toll in this age group <br> has reached up to half a million annually, closely followed by those aged 50-69 years. A significant portion of these deaths occur among the working-age population, suggesting that professional pressures and stress could be major contributing factors to the decline in mental health, particularly for individuals aged 15-49."


gr3 <- ggplot(df_substance_deaths_age_long_grouped, aes(id = age_group_clean,area = Total_deaths,fill = Total_deaths)) +
  geom_circlepack() +
    geom_circlepack_text( aes(y = after_stat(y+ 0.1),
                              label = Total_deaths_label),
                           family = "text",color = "white", 
                           fontface = "bold", lineheight = 0.3,size = 4.7) +
  geom_circlepack_text(aes(label = age_group_clean),color = "#f1fffe",size = 2.5,
                       check_overlap = TRUE,family = "caption", lineheight = 0.9) +
  facet_wrap(~year) +
  scale_color_identity() +
  theme_void() +
   labs(title = title_text,
        subtitle = subtitle_text,
        caption = "Source: World Health Organisation (2024)") +
  theme(
    legend.position = "none",
    panel.spacing.y = unit(2, "lines"),
    strip.text = element_text(color = "#2E4053", 
                              size = rel(1.5),
                              family = "subtitle"),
    plot.margin = margin(10, 20, 10, 30),
    plot.title            = element_markdown(
      size                = rel(1.3),
      family              = "title",
      face                = "bold",
      color               = title_col,
      lineheight          = 0.3,
      margin              = margin(t = 5, b = 5),
      hjust               = 0.5
    ),        
    plot.subtitle         = element_markdown(
      size                = rel(1), 
      family              = 'subtitle',
      color               = subtitle_col,
      hjust               = 0,
      lineheight          = 0.1, 
      margin              = margin(t = 5, b = 1)
    ),
    plot.caption          = element_markdown(
      size                = rel(0.8), 
      family              = 'caption',
      color               = caption_col,
      lineheight          = 0.3,
      hjust               = 1,
      halign              = 0,
      margin              = margin(t = 10, b = 10)
    )
  ) + scale_fill_continuous_tableau(palette = "Classic Red") +
  coord_equal()

gr3
ggsave("images/Global_death_rate_age.jpeg",gr3,dpi = 300,height = 6, width = 10)
```

```{r}
df_drug_dependency <- df_drug_dependency %>% clean_names()

title_text <- "Elevated Risk of Substance Dependence Among Professionals in High-Stress Work Environments"
subtitle_text <- "A high-pressure work environment can significantly impact the mental well-being <br> of professionals, often making them vulnerable to mental health disorders. <br> Statistics show a strong correlation between developing a mental health <br> condition and subsequent substance dependence. Among working professionals, <br> the most common mental health disorders include <strong> ADHD, Social Phobia, Major Depression, <br> and Generalized Anxiety Disorder </strong>. The values presented indicate the likelihood <br> of individuals who develop one of these conditions also turning to substance use as a coping mechanism. A person with a diagnosed ADHD condition is <span style='color: darkred;'>5.2 times likely </span> to fall victim to substance use."

work_conditions <- c("Generalized anxiety disorder (GAD)","Major depression",
                     "Social phobia","Any Anxiety Disorder","Attention deficit hyperactivity (ADHD)")

gr4 <- ggplot(data = df_drug_dependency,aes(x = increased_risk_of_illicit_drug_dependency,
                                     y = reorder(entity,increased_risk_of_illicit_drug_dependency))) + 
  geom_col(fill = "lightgray") + 
  geom_col(data = df_drug_dependency %>% filter(entity %in% work_conditions) ,fill = "#CD5C5C") +
  geom_text(aes(label = increased_risk_of_illicit_drug_dependency,hjust = 1,fontface = "bold"),color = "white") +
  labs(x = "Risk of substance dependency",
       y = "Diagnosed conditions",
       title = title_text,
       subtitle = subtitle_text,
       caption = "Source: Swendsen et al. (2010)") +
  theme_minimal() +
  theme(legend.position = "none",
    legend.title = element_text(
      color = text_col,
      hjust = 0.5,
      family = "text",
      face = "bold",
      size = rel(1),
    ),
    legend.text = element_text(
      color = text_col,
      family = "text",
      size = rel(1),
      face = "bold"
    ),
    plot.title            = element_text(
      size                = rel(1.1),
      family              = "title",
      face                = "bold",
      color               = title_col,
      lineheight          = 0.3,
      margin              = margin(t = 5, b = 5),
      hjust               = 0.5
    ),        
    plot.subtitle         = element_markdown(
      size                = rel(0.9), 
      family              = 'subtitle',
      color               = subtitle_col,
      hjust               = 0,
      lineheight          = 0.2, 
      margin              = margin(t = 5, b = 1)
    ),
      plot.caption          = element_markdown(
      size                = rel(0.8), 
      family              = 'caption',
      color               = caption_col,
      lineheight          = 0.3,
      hjust               = 1,
      halign              = 0,
      margin              = margin(t = 10, b = 10)
    ),
    axis.title = element_markdown(
      size = rel(0.7),
      family = "caption",
      face = "bold"
    ),
    axis.text  = element_markdown(
      size = rel(0.7),
      face = "bold",
      family = "caption"
    )
  ) 
gr4
ggsave("images/drug_dependency.jpeg",gr4,dpi = 300,height = 6, width = 10)
```

